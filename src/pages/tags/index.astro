---
import { getAllUniqueTagsWithCount } from "@/data/entry";
import PageLayout from "@/layouts/Base.astro";

const allTags = await getAllUniqueTagsWithCount();

// Sort tags alphabetically, with "untagged" at the bottom
const sortedTags = allTags.sort(([tagA], [tagB]) => {
  if (tagA === "untagged") return 1;
  if (tagB === "untagged") return -1;
  return tagA.localeCompare(tagB);
});

// Get unique starting characters for navigation
const startingChars = Array.from(
  new Set(
    sortedTags
      .filter(([tag]) => tag !== "untagged")
      .map(([tag]) => tag.charAt(0).toUpperCase()),
  ),
).sort();

const meta = {
  description: "A list of all the topics I've written about in my posts",
  title: "All Tags",
};
---

<PageLayout meta={meta}>
  <h1 class="title page-title">Tags</h1>

  <!-- Navigation bar for quick jumping -->
  {
    startingChars.length > 0 && (
      <nav class="tags-nav">
        <div class="tags-nav-list">
          {startingChars.map((char) => (
            <a href={`#letter-${char}`} class="tags-nav-link">
              {char}
            </a>
          ))}
        </div>
      </nav>
    )
  }

  <ul class="tags-list">
    {
      sortedTags.map(([tag, val]: [string, number], index: number) => {
        const currentChar =
          tag !== "untagged" ? tag.charAt(0).toUpperCase() : "";
        const prevTag = index > 0 ? (sortedTags[index - 1]?.[0] ?? "") : "";
        const prevChar =
          prevTag !== "untagged" ? prevTag.charAt(0).toUpperCase() : "";
        const isNewSection = currentChar !== prevChar && tag !== "untagged";
        const isUntagged = tag === "untagged";

        return (
          <>
            {isNewSection && (
              <li>
                <h2 id={`letter-${currentChar}`} class="tags-section-title">
                  {currentChar}
                </h2>
              </li>
            )}
            {isUntagged && <li class="tag-divider" />}
            <li class="tag-row">
              <a
                class="custom-link"
                data-astro-prefetch
                href={`/tags/${tag}/`}
                title={
                  tag === "untagged"
                    ? "View posts without tags"
                    : `View posts with the tag: ${tag}`
                }
              >
                {`${tag}`}
              </a>
              <span class="inline-block">- ({val})</span>
            </li>
          </>
        );
      })
    }
  </ul>
</PageLayout>
